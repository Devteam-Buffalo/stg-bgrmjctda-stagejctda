<?php
/**
 * Project Name:    Discover Jackson NC
 * Project URI:     https://www.discoverjacksonnc.com
 * Description:     Filters the post title.
 * Agency:          Rawle Murdy Associates
 * Agency URI:      https://www.rawlemurdy.com
 * Text Domain:     jctda
 *
 * @package         jctda
 * @since           0.71
 * @link            https://www.discoverjacksonnc.com
 * @author          lpeterson
 * @date            6/6/18
 * @file            the-title.php
 * 
 * @param string $title The post title. 
 * @param int    $id    The post ID. 
 */
defined('ABSPATH') or exit;

add_filter( 'the_title', function( $title, $id = null ) {
	if ( is_admin() || !isset( $id ) || !in_the_loop() )
		return $title;

	if ( is_post_type_archive( 'mentions' ) ) {
		$key = md5( $id.$title );
		$post_title = wp_cache_get( $key, 'post_title' );
	
		if ( false === $post_title ) {
			$post_titles = [ 'article_title', 'publication_title' ];

			foreach ( $post_titles as $meta_title ) {
				switch ( true ) {
					case metadata_exists( 'post', $id, $meta_title ):
						$post_title = get_post_meta( $id, $meta_title, true );
						break;
					default:
						$post_title = $title;
						break;
				}
			}

			wp_cache_set( $key, $post_title, 'post_title', MINUTE_IN_SECONDS*15 );
		}
		
		$title = sprintf( '<i>%s: </i>%s', $post_title, $title );
	}

	if ( is_post_type_archive( [ 'press_release', 'b2b_news', 'tda_docs' ] ) ) {
		$key = md5( $id.$title );
		$post_title = wp_cache_get( $key, 'post_title' );
	
		if ( false === $post_title ) {
			$post_title = metadata_exists( 'post', $id, 'page_heading' ) ? get_post_meta( $id, 'page_heading', true ) : $title;

			wp_cache_set( $key, $post_title, 'post_title', MINUTE_IN_SECONDS*15 );
		}
		
		$title = $post_title;
	}

	return $title;
}, 10, 2 );